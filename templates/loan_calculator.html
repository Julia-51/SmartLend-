{% extends "base.html" %}
{% block content %}
<h2>{{ t['loan_calculator'] }}</h2>

<form method="post" class="card card-body shadow-sm">
  <div class="mb-3">
    <label>{{ t['amount'] }}</label>
    <input type="number" step="0.01" name="amount" class="form-control" required>
  </div>
  <div class="mb-3">
    <label>{{ t['duration'] }} ({{ t['months'] }})</label>
    <input type="number" name="months" class="form-control" required>
  </div>
  <button class="btn btn-primary">{{ t['calculate'] }}</button>
</form>

{% if result %}
<div class="card card-body shadow-sm mt-4">
  <h4>{{ t['result'] }}</h4>
  <ul>
    <li>{{ t['fees'] }}: {{ fees }} €</li>
    <li>{{ t['monthly_payment'] }}: {{ monthly_payment }} €</li>
    <li>{{ t['total_payment'] }}: {{ total_payment }} €</li>
  </ul>

  <p><strong>{{ t['iban_info'] }}:</strong> {{ iban }}</p>

  {% if loan_id %}
    <form method="post" action="{{ url_for('mark_paid', loan_id=loan_id, lang=lang) }}">
      <button class="btn btn-warning">{{ t['mark_paid'] }}</button>
    </form>
  {% endif %}

  <form method="post" action="{{ url_for('download_receipt', lang=lang) }}" class="mt-3">
    <input type="hidden" name="amount" value="{{ amount }}">
    <input type="hidden" name="months" value="{{ months }}">
    <input type="hidden" name="fees" value="{{ fees }}">
    <input type="hidden" name="monthly" value="{{ monthly_payment }}">
    <input type="hidden" name="total" value="{{ total_payment }}">
    <label>{{ t['signature'] }}</label>
    <canvas id="sigPad" class="border w-100" height="150"></canvas>
    <input type="hidden" name="signature" id="sigInput">
    <div class="mt-2">
      <button type="button" class="btn btn-secondary btn-sm" onclick="clearSig()">Effacer</button>
      <button type="submit" class="btn btn-success btn-sm" onclick="saveSig()">{{ t['download_pdf'] }}</button>
    </div>
  </form>
</div>
{% endif %}

<script>
let canvas = document.getElementById("sigPad");
let ctx = canvas.getContext("2d");
let drawing = false;

canvas.addEventListener("mousedown", e => {drawing=true; ctx.moveTo(e.offsetX, e.offsetY);});
canvas.addEventListener("mousemove", e => {if(drawing){ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke();}});
canvas.addEventListener("mouseup", e => {drawing=false;});
canvas.addEventListener("mouseleave", e => {drawing=false;});

function clearSig(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
}
function saveSig(){
  document.getElementById("sigInput").value = canvas.toDataURL();
}
</script>
{% endblock %}
